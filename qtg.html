<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Найдите столицу любой страны, проверьте свои знания в викторине по столицам или угадайте страну по флагу.">
  <title>Столицы стран</title>
  <script src="https://telegram.org/js/telegram-web-app.js" onerror="console.error('Failed to load Telegram WebApp script'); alert('Error: Failed to load Telegram WebApp. Check your connection.');"></script>
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" onerror="console.error('Failed to load React script'); alert('Error: Failed to load React. Check your connection.');"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" onerror="console.error('Failed to load ReactDOM script'); alert('Error: Failed to load ReactDOM. Check your connection.');"></script>
  <script src="https://cdn.tailwindcss.com" onerror="console.error('Failed to load Tailwind CSS script'); alert('Error: Failed to load Tailwind CSS. Check your connection.');"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          animation: {
            'pulse': 'pulse 1s ease-out',
            'slide-up': 'slideUp 0.5s ease-out',
            'wave-in': 'waveIn 0.4s ease-out forwards',
            'shake': 'shake 0.5s ease-in-out',
            'slide-in': 'slideIn 0.4s ease-out',
            'clear-pulse': 'clearPulse 0.3s ease-in-out',
            'fade-out': 'fadeOut 0.4s ease-out forwards'
          },
          keyframes: {
            pulse: {
              '0%': { opacity: '0', transform: 'scale(0.95) translateY(-20px)' },
              '50%': { transform: 'scale(1.05)' },
              '100%': { opacity: '1', transform: 'scale(1) translateY(0)' }
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            waveIn: {
              '0%': { opacity: '0', transform: 'translateX(-10px) rotateY(30deg)' },
              '100%': { opacity: '1', transform: 'translateX(0) rotateY(0)' }
            },
            shake: {
              '0%, 100%': { transform: 'translateX(0)' },
              '20%': { transform: 'translateX(-10px) rotate(-2deg)' },
              '40%': { transform: 'translateX(10px) rotate(2deg)' },
              '60%': { transform: 'translateX(-5px) rotate(-1deg)' },
              '80%': { transform: 'translateX(5px) rotate(1deg)' }
            },
            slideIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' }
            },
            clearPulse: {
              '0%': { transform: 'translateY(-50%) scale(1)', opacity: '0.7' },
              '50%': { transform: 'translateY(-50%) scale(1.2)', opacity: '1' },
              '100%': { transform: 'translateY(-50%) scale(1)', opacity: '0.7' }
            },
            fadeOut: {
              '0%': { opacity: '1', transform: 'scale(1)' },
              '100%': { opacity: '0', transform: 'scale(0.95)' }
            }
          }
        }
      }
    };
  </script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --input-bg: #ffffff;
      --input-border: #d1d5db;
      --button-bg: #3390ec;
      --button-text: #ffffff;
      --button-hover: #2563eb;
      --suggestions-bg: #ffffff;
      --suggestions-border: #d1d5db;
      --suggestions-hover: #f3f4f6;
      --theme-button-bg: #e5e7eb;
      --theme-button-text: #374151;
      --error-text: #ef4444;
      --success-text: #10b981;
      --quiz-button-bg: #3390ec;
      --quiz-button-hover: #2563eb;
      --quiz-button-active: #1e40af;
      --quiz-correct-bg: #10b981;
      --quiz-incorrect-bg: #ef4444;
      transition: all 0.3s ease;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    input::placeholder {
      color: var(--text-color);
      opacity: 0.6;
    }

    #suggestions li {
      transition: background-color 0.2s ease, transform 0.2s ease;
      animation-delay: calc(var(--index) * 0.1s);
      background-color: var(--suggestions-bg);
    }

    #suggestions li:hover {
      transform: scale(1.03) translateX(5px);
      background-color: var(--suggestions-hover);
    }

    #countryInput {
      background-color: var(--input-bg);
      border-color: var(--input-border);
      color: var(--text-color);
    }

    button {
      background-color: var(--button-bg);
      color: var(--button-text);
    }

    button:hover:not(:disabled) {
      background-color: var(--button-hover);
    }

    button:active:not(:disabled) {
      transform: scale(0.95);
      background-color: var(--button-hover);
    }

    #suggestions {
      background-color: var(--suggestions-bg);
      border-color: var(--suggestions-border);
    }

    #result.error {
      color: var(--error-text);
      animation: shake 0.5s ease-in-out;
    }

    #langToggle {
      background-color: var(--theme-button-bg);
      color: var(--theme-button-text);
    }

    #langToggle:hover {
      background-color: var(--button-hover);
      color: var(--button-text);
    }

    #langToggle:active {
      transform: scale(0.95);
    }

    #countryInfo {
      background-color: var(--suggestions-bg);
      border-color: var(--suggestions-border);
    }

    #result img, #quizQuestion img, #flagQuizQuestion img {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }

    #clearInput {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background-color: var(--input-bg);
      color: var(--text-color);
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0.7;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #clearInput:hover {
      opacity: 1;
      background-color: var(--suggestions-hover);
    }

    #clearInput.hidden {
      display: none;
    }

    .tab {
      background-color: var(--theme-button-bg);
      color: var(--theme-button-text);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .tab:hover {
      background-color: var(--button-hover);
      color: var(--button-text);
    }

    .tab.active {
      background-color: var(--button-bg);
      color: var(--button-text);
    }

    .quiz-option {
      background-color: var(--quiz-button-bg);
      color: var(--button-text);
      padding: 0.75rem;
      border-radius: 8px;
      width: 100%;
      text-align: center;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .quiz-option:hover:not(:disabled) {
      background-color: var(--quiz-button-hover);
      transform: scale(1.03);
    }

    .quiz-option:active:not(:disabled) {
      background-color: var(--quiz-button-active);
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }

    .quiz-option:focus {
      outline: none;
    }

    .quiz-option.correct {
      background-color: var(--quiz-correct-bg);
      color: var(--button-text);
    }

    .quiz-option.incorrect {
      background-color: var(--quiz-incorrect-bg);
      color: var(--button-text);
    }

    #quizScore, #flagQuizScore {
      background-color: var(--suggestions-bg);
      border: 1px solid var(--suggestions-border);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
      font-weight: 500;
    }

    #errorBoundary {
      background-color: var(--suggestions-bg);
      border: 1px solid var(--error-text);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      color: var(--error-text);
    }

    @media (max-width: 600px) {
      .container {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="root" class="container w-full max-w-sm p-4"></div>

  <script>
    // Initialize Telegram WebApp
    try {
      if (!window.Telegram || !window.Telegram.WebApp) {
        console.warn('Telegram WebApp not loaded. Using fallback colors.');
      } else {
        console.log('Telegram WebApp loaded, version:', window.Telegram.WebApp.version);
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();
      }
    } catch (error) {
      console.error('Error initializing Telegram WebApp:', error);
      alert('Error initializing Telegram WebApp. Check console.');
    }

    // Check React and ReactDOM dependencies
    try {
      if (!window.React || !window.ReactDOM) {
        console.error('Error: React or ReactDOM not loaded.');
        alert('Error loading React. Check your internet connection.');
        throw new Error('React not loaded');
      }
    } catch (error) {
      console.error('Error checking React dependencies:', error);
      alert('Error loading React dependencies. Check console.');
    }

    const countries = {
      "Россия": {
        capital: "Москва",
        code: "ru",
        en: "Russia",
        enCapital: "Moscow",
        region: "Европа",
        population: "12,600,000",
        language: "Русский"
      },
      "Франция": {
        capital: "Париж",
        code: "fr",
        en: "France",
        enCapital: "Paris",
        region: "Европа",
        population: "2,165,000",
        language: "Французский"
      },
      "США": {
        capital: "Вашингтон",
        code: "us",
        en: "United States",
        enCapital: "Washington, D.C.",
        region: "Северная Америка",
        population: "705,749",
        language: "Английский"
      }
    };

    class ErrorBoundary extends React.Component {
      state = { hasError: false, error: null };

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('ErrorBoundary caught error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return React.createElement(
            'div',
            { id: 'errorBoundary' },
            'Something went wrong. Please check the console and try again.'
          );
        }
        return this.props.children;
      }
    }

    function SearchTab({ lang, result, setResult, countryInfo, setCountryInfo, countryInput, setCountryInput, suggestions, setSuggestions }) {
      const tg = window.Telegram?.WebApp;

      const handleInput = (e) => {
        try {
          const input = e.target.value;
          setCountryInput(input);
          if (input.length < 2) {
            setSuggestions([]);
            return;
          }
          const matches = Object.keys(countries)
            .filter(country =>
              (lang === 'ru' ? country : countries[country].en)
                .toLowerCase()
                .includes(input.toLowerCase())
            )
            .slice(0, 5);
          setSuggestions(matches);
        } catch (error) {
          console.error('Error in handleInput:', error);
        }
      };

      const handleSuggestionClick = (country) => {
        try {
          setCountryInput(lang === 'ru' ? country : countries[country].en);
          setSuggestions([]);
          findCapital(country);
        } catch (error) {
          console.error('Error in handleSuggestionClick:', error);
        }
      };

      const findCapital = (input) => {
        try {
          console.log('Searching capital for:', input);
          setResult(null);
          setCountryInfo(null);
          const countryKey = Object.keys(countries).find(
            key =>
              key.toLowerCase() === input.toLowerCase() ||
              countries[key].en.toLowerCase() === input.toLowerCase()
          );

          if (countryKey) {
            const country = countries[countryKey];
            const flag = `https://flagcdn.com/96x72/${country.code}.png`;
            const capital = lang === 'ru' ? country.capital : country.enCapital;
            setResult({ flag, capital, error: false });
            setCountryInfo({
              region: country.region,
              population: country.population,
              language: country.language
            });
            if (tg && typeof tg.showAlert === 'function') {
              console.log('Calling showAlert for found capital:', capital);
              tg.showAlert(`${lang === 'ru' ? 'Столица найдена' : 'Capital found'}: ${capital}`);
            } else {
              console.warn('showAlert not available, using standard alert');
              alert(`${lang === 'ru' ? 'Столица найдена' : 'Capital found'}: ${capital}`);
            }
          } else {
            setResult({ error: true, message: lang === 'ru' ? 'Страна не найдена' : 'Country not found' });
            if (tg && typeof tg.showAlert === 'function') {
              console.log('Calling showAlert for error: Country not found');
              tg.showAlert(lang === 'ru' ? 'Страна не найдена' : 'Country not found');
            } else {
              console.warn('showAlert not available, using standard alert');
              alert(lang === 'ru' ? 'Страна не найдена' : 'Country not found');
            }
          }
        } catch (error) {
          console.error('Error in findCapital:', error);
          setResult({ error: true, message: 'Error processing request' });
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error processing request');
          } else {
            alert('Error processing request');
          }
        }
      };

      const clearInput = () => {
        try {
          setCountryInput('');
          setResult(null);
          setCountryInfo(null);
          setSuggestions([]);
        } catch (error) {
          console.error('Error in clearInput:', error);
        }
      };

      return (
        React.createElement(
          'div',
          { id: 'searchContainer' },
          React.createElement(
            'div',
            { className: 'relative' },
            React.createElement(
              'input',
              {
                id: 'countryInput',
                placeholder: lang === 'ru' ? 'Введите страну' : 'Enter country',
                value: countryInput,
                onChange: handleInput,
                onKeyPress: (e) => e.key === 'Enter' && findCapital(countryInput),
                className: 'w-full p-2 rounded-lg border bg-[var(--input-bg)] border-[var(--input-border)] text-[var(--text-color)]'
              }
            ),
            React.createElement(
              'button',
              {
                id: 'clearInput',
                className: `absolute right-2 top-1/2 transform -translate-y-1/2 ${countryInput ? '' : 'hidden'}`,
                onClick: clearInput
              },
              '×'
            ),
            React.createElement(
              'ul',
              { id: 'suggestions', className: `absolute w-full rounded-lg mt-1 max-h-40 overflow-y-auto border bg-[var(--suggestions-bg)] border-[var(--suggestions-border)] ${suggestions.length ? '' : 'hidden'}` },
              suggestions.map((country, index) =>
                React.createElement(
                  'li',
                  {
                    key: country,
                    className: 'p-2 cursor-pointer animate-wave-in',
                    style: { '--index': index },
                    onClick: () => handleSuggestionClick(country)
                  },
                  lang === 'ru' ? country : countries[country].en
                )
              )
            )
          ),
          React.createElement(
            'button',
            {
              id: 'findButton',
              className: 'mt-2 w-full p-2 rounded-lg bg-[var(--button-bg)] text-[var(--button-text)]',
              onClick: () => findCapital(countryInput)
            },
            lang === 'ru' ? 'Найти столицу' : 'Find Capital'
          ),
          result && React.createElement(
            'div',
            { id: 'result', className: `mt-4 text-center flex items-center justify-center gap-2 ${result.error ? 'error' : 'animate-slide-in'}` },
            !result.error && React.createElement('img', {
              src: result.flag,
              alt: 'Flag',
              className: 'w-6 h-6',
              onError: () => console.error('Error loading flag:', result.flag)
            }),
            React.createElement('span', null, result.error ? result.message : `${lang === 'ru' ? 'Столица' : 'Capital'}: ${result.capital}`)
          ),
          countryInfo && React.createElement(
            'div',
            { id: 'countryInfo', className: 'mt-2 p-2 rounded-lg border bg-[var(--suggestions-bg)] border-[var(--suggestions-border)] animate-slide-in' },
            React.createElement('p', null, `${lang === 'ru' ? 'Регион' : 'Region'}: ${countryInfo.region}`),
            React.createElement('p', null, `${lang === 'ru' ? 'Население' : 'Population'}: ${countryInfo.population}`),
            React.createElement('p', null, `${lang === 'ru' ? 'Язык' : 'Language'}: ${countryInfo.language}`)
          )
        )
      );
    }

    function QuizTab({ lang, correctAnswers, incorrectAnswers, setCorrectAnswers, setIncorrectAnswers }) {
      const [quizQuestion, setQuizQuestion] = React.useState(null);
      const [quizOptions, setQuizOptions] = React.useState([]);
      const tg = window.Telegram?.WebApp;

      const startQuiz = () => {
        try {
          console.log('Starting quiz, resetting options');
          setQuizQuestion(null);
          setQuizOptions([]);
          const countryKeys = Object.keys(countries);
          if (countryKeys.length < 2) {
            setQuizQuestion({ error: true, message: lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries' });
            if (tg && typeof tg.showAlert === 'function') {
              console.log('Calling showAlert for error: Not enough countries');
              tg.showAlert(lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries');
            } else {
              console.warn('showAlert not available, using standard alert');
              alert(lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries');
            }
            return;
          }

          const randomCountry = countryKeys[Math.floor(Math.random() * countryKeys.length)];
          const country = countries[randomCountry];
          const flag = `https://flagcdn.com/96x72/${country.code}.png`;
          const correctCapital = lang === 'ru' ? country.capital : country.enCapital;

          setQuizQuestion({ flag, country: lang === 'ru' ? randomCountry : country.en });

          const allCapitals = countryKeys.map(key => lang === 'ru' ? countries[key].capital : countries[key].enCapital);
          const wrongCapitals = allCapitals
            .filter(capital => capital !== correctCapital)
            .sort(() => Math.random() - 0.5)
            .slice(0, 1);
          const options = [correctCapital, ...wrongCapitals].sort(() => Math.random() - 0.5);
          setQuizOptions(options.map(option => ({
            text: option,
            correct: option === correctCapital,
            className: 'quiz-option',
            disabled: false
          })));
          // Ensure no button is focused or active on render
          setTimeout(() => {
            document.querySelectorAll('#quizOptions button').forEach(button => {
              button.blur();
            });
            console.log('Ensured no buttons are focused on quiz start');
          }, 0);
        } catch (error) {
          console.error('Error in startQuiz:', error);
          setQuizQuestion({ error: true, message: 'Error starting quiz' });
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error starting quiz');
          } else {
            alert('Error starting quiz');
          }
        }
      };

      const checkAnswer = (selected) => {
        try {
          console.log('Checking quiz answer, selected:', selected);
          console.log('Applying active state');
          // Delay to allow active state (scale: 0.95) to complete
          setTimeout(() => {
            console.log('Reverting to normal state');
            setQuizOptions(prev =>
              prev.map(option => ({
                ...option,
                className: 'quiz-option' // Revert to normal state
              }))
            );
            // Apply correct/incorrect and fade-out after normal state
            setTimeout(() => {
              console.log('Applying result state and fade-out');
              setQuizOptions(prev =>
                prev.map(option => ({
                  ...option,
                  disabled: true,
                  className: `quiz-option ${option.text === selected ? (option.correct ? 'correct fade-out' : 'incorrect fade-out') : (option.correct ? 'correct fade-out' : 'fade-out')}`
                }))
              );
              // Clear focus from all buttons
              document.querySelectorAll('#quizOptions button').forEach(button => {
                button.blur();
              });
              if (selected === quizOptions.find(opt => opt.correct).text) {
                setCorrectAnswers(prev => {
                  const newCount = prev + 1;
                  localStorage.setItem('correctAnswers', newCount);
                  return newCount;
                });
                if (tg && typeof tg.showAlert === 'function') {
                  console.log('Calling showAlert for correct answer');
                  tg.showAlert(lang === 'ru' ? 'Правильно!' : 'Correct!', () => {
                    console.log('Triggering next question after alert');
                    setTimeout(startQuiz, 400); // Wait for fade-out animation
                  });
                } else {
                  console.warn('showAlert not available, using standard alert');
                  alert(lang === 'ru' ? 'Правильно!' : 'Correct!');
                  setTimeout(startQuiz, 900); // 400ms fade-out + 500ms for alert
                }
              } else {
                setIncorrectAnswers(prev => {
                  const newCount = prev + 1;
                  localStorage.setItem('incorrectAnswers', newCount);
                  return newCount;
                });
                if (tg && typeof tg.showAlert === 'function') {
                  console.log('Calling showAlert for incorrect answer');
                  tg.showAlert(lang === 'ru' ? 'Неправильно!' : 'Incorrect!', () => {
                    console.log('Triggering next question after alert');
                    setTimeout(startQuiz, 400); // Wait for fade-out animation
                  });
                } else {
                  console.warn('showAlert not available, using standard alert');
                  alert(lang === 'ru' ? 'Неправильно!' : 'Incorrect!');
                  setTimeout(startQuiz, 900); // 400ms fade-out + 500ms for alert
                }
              }
            }, 100); // Brief hold after reverting to normal state
          }, 200); // Allow active state to complete
        } catch (error) {
          console.error('Error in checkAnswer:', error);
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error processing answer');
          } else {
            alert('Error processing answer');
          }
        }
      };

      React.useEffect(() => {
        startQuiz();
      }, [lang]);

      return (
        React.createElement(
          'div',
          { id: 'quizContainer' },
          React.createElement(
            'div',
            { id: 'quizScore', className: 'text-center mb-2 p-2 rounded-lg border bg-[var(--suggestions-bg)] border-[var(--suggestions-border)]' },
            lang === 'ru'
              ? `Правильных: ${correctAnswers}, Неправильных: ${incorrectAnswers}`
              : `Correct: ${correctAnswers}, Incorrect: ${incorrectAnswers}`
          ),
          quizQuestion && (
            React.createElement(
              'div',
              { id: 'quizQuestion', className: `text-center flex items-center justify-center gap-2 mb-2 ${quizQuestion.error ? 'error' : 'animate-slide-in'}` },
              !quizQuestion.error && React.createElement('img', {
                src: quizQuestion.flag,
                alt: 'Flag',
                className: 'w-6 h-6'
              }),
              React.createElement('span', null, quizQuestion.error ? quizQuestion.message : `${lang === 'ru' ? 'Назови столицу' : 'Name the capital'}: ${quizQuestion.country}`)
            )
          ),
          React.createElement(
            'div',
            { id: 'quizOptions', className: 'grid gap-2' },
            quizOptions.map(option =>
              React.createElement(
                'button',
                {
                  key: option.text,
                  className: option.className || 'quiz-option',
                  onClick: () => checkAnswer(option.text),
                  disabled: option.disabled
                },
                option.text
              )
            )
          ),
          React.createElement(
            'div',
            { className: 'flex gap-2 mt-2' },
            React.createElement(
              'button',
              {
                id: 'resetQuiz',
                className: 'w-full p-2 rounded-lg bg-[var(--button-bg)] text-[var(--button-text)]',
                onClick: () => {
                  console.log('Clicked Reset button in quiz');
                  setCorrectAnswers(0);
                  setIncorrectAnswers(0);
                  localStorage.setItem('correctAnswers', 0);
                  localStorage.setItem('incorrectAnswers', 0);
                  startQuiz();
                }
              },
              lang === 'ru' ? 'Сбросить' : 'Reset'
            )
          )
        )
      );
    }

    function FlagQuizTab({ lang, flagCorrectAnswers, flagIncorrectAnswers, setFlagCorrectAnswers, setFlagIncorrectAnswers }) {
      const [flagQuizQuestion, setFlagQuizQuestion] = React.useState(null);
      const [flagQuizOptions, setFlagQuizOptions] = React.useState([]);
      const tg = window.Telegram?.WebApp;

      const startFlagQuiz = () => {
        try {
          console.log('Starting flag quiz, resetting options');
          setFlagQuizQuestion(null);
          setFlagQuizOptions([]);
          const countryKeys = Object.keys(countries);
          if (countryKeys.length < 2) {
            setFlagQuizQuestion({ error: true, message: lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries' });
            if (tg && typeof tg.showAlert === 'function') {
              console.log('Calling showAlert for error: Not enough countries');
              tg.showAlert(lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries');
            } else {
              console.warn('showAlert not available, using standard alert');
              alert(lang === 'ru' ? 'Недостаточно стран' : 'Not enough countries');
            }
            return;
          }

          const randomCountry = countryKeys[Math.floor(Math.random() * countryKeys.length)];
          const country = countries[randomCountry];
          const flag = `https://flagcdn.com/96x72/${country.code}.png`;
          const correctCountry = lang === 'ru' ? randomCountry : country.en;

          setFlagQuizQuestion({ flag });

          const allCountries = countryKeys.map(key => lang === 'ru' ? key : countries[key].en);
          const wrongCountries = allCountries
            .filter(c => c !== correctCountry)
            .sort(() => Math.random() - 0.5)
            .slice(0, 1);
          const options = [correctCountry, ...wrongCountries].sort(() => Math.random() - 0.5);
          setFlagQuizOptions(options.map(option => ({
            text: option,
            correct: option === correctCountry,
            className: 'quiz-option',
            disabled: false
          })));
          // Ensure no button is focused or active on render
          setTimeout(() => {
            document.querySelectorAll('#flagQuizOptions button').forEach(button => {
              button.blur();
            });
            console.log('Ensured no buttons are focused on flag quiz start');
          }, 0);
        } catch (error) {
          console.error('Error in startFlagQuiz:', error);
          setFlagQuizQuestion({ error: true, message: 'Error starting flag quiz' });
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error starting flag quiz');
          } else {
            alert('Error starting flag quiz');
          }
        }
      };

      const checkAnswer = (selected) => {
        try {
          console.log('Checking flag quiz answer, selected:', selected);
          console.log('Applying active state');
          // Delay to allow active state (scale: 0.95) to complete
          setTimeout(() => {
            console.log('Reverting to normal state');
            setFlagQuizOptions(prev =>
              prev.map(option => ({
                ...option,
                className: 'quiz-option' // Revert to normal state
              }))
            );
            // Apply correct/incorrect and fade-out after normal state
            setTimeout(() => {
              console.log('Applying result state and fade-out');
              setFlagQuizOptions(prev =>
                prev.map(option => ({
                  ...option,
                  disabled: true,
                  className: `quiz-option ${option.text === selected ? (option.correct ? 'correct fade-out' : 'incorrect fade-out') : (option.correct ? 'correct fade-out' : 'fade-out')}`
                }))
              );
              // Clear focus from all buttons
              document.querySelectorAll('#flagQuizOptions button').forEach(button => {
                button.blur();
              });
              if (selected === flagQuizOptions.find(opt => opt.correct).text) {
                setFlagCorrectAnswers(prev => {
                  const newCount = prev + 1;
                  localStorage.setItem('flagCorrectAnswers', newCount);
                  return newCount;
                });
                if (tg && typeof tg.showAlert === 'function') {
                  console.log('Calling showAlert for correct answer');
                  tg.showAlert(lang === 'ru' ? 'Правильно!' : 'Correct!', () => {
                    console.log('Triggering next question after alert');
                    setTimeout(startFlagQuiz, 400); // Wait for fade-out animation
                  });
                } else {
                  console.warn('showAlert not available, using standard alert');
                  alert(lang === 'ru' ? 'Правильно!' : 'Correct!');
                  setTimeout(startFlagQuiz, 900); // 400ms fade-out + 500ms for alert
                }
              } else {
                setFlagIncorrectAnswers(prev => {
                  const newCount = prev + 1;
                  localStorage.setItem('flagIncorrectAnswers', newCount);
                  return newCount;
                });
                if (tg && typeof tg.showAlert === 'function') {
                  console.log('Calling showAlert for incorrect answer');
                  tg.showAlert(lang === 'ru' ? 'Неправильно!' : 'Incorrect!', () => {
                    console.log('Triggering next question after alert');
                    setTimeout(startFlagQuiz, 400); // Wait for fade-out animation
                  });
                } else {
                  console.warn('showAlert not available, using standard alert');
                  alert(lang === 'ru' ? 'Неправильно!' : 'Incorrect!');
                  setTimeout(startFlagQuiz, 900); // 400ms fade-out + 500ms for alert
                }
              }
            }, 100); // Brief hold after reverting to normal state
          }, 200); // Allow active state to complete
        } catch (error) {
          console.error('Error in checkAnswer:', error);
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error processing answer');
          } else {
            alert('Error processing answer');
          }
        }
      };

      React.useEffect(() => {
        startFlagQuiz();
      }, [lang]);

      return (
        React.createElement(
          'div',
          { id: 'flagQuizContainer' },
          React.createElement(
            'div',
            { id: 'flagQuizScore', className: 'text-center mb-2 p-2 rounded-lg border bg-[var(--suggestions-bg)] border-[var(--suggestions-border)]' },
            lang === 'ru'
              ? `Правильных: ${flagCorrectAnswers}, Неправильных: ${flagIncorrectAnswers}`
              : `Correct: ${flagCorrectAnswers}, Incorrect: ${flagIncorrectAnswers}`
          ),
          flagQuizQuestion && (
            React.createElement(
              'div',
              { id: 'flagQuizQuestion', className: `text-center flex items-center justify-center gap-2 mb-2 ${flagQuizQuestion.error ? 'error' : 'animate-slide-in'}` },
              !flagQuizQuestion.error && React.createElement('img', {
                src: flagQuizQuestion.flag,
                alt: 'Flag',
                className: 'w-6 h-6'
              }),
              React.createElement('span', null, flagQuizQuestion.error ? flagQuizQuestion.message : (lang === 'ru' ? 'Назови страну' : 'Name the country'))
            )
          ),
          React.createElement(
            'div',
            { id: 'flagQuizOptions', className: 'grid gap-2' },
            flagQuizOptions.map(option =>
              React.createElement(
                'button',
                {
                  key: option.text,
                  className: option.className || 'quiz-option',
                  onClick: () => checkAnswer(option.text),
                  disabled: option.disabled
                },
                option.text
              )
            )
          ),
          React.createElement(
            'div',
            { className: 'flex gap-2 mt-2' },
            React.createElement(
              'button',
              {
                id: 'resetFlagQuiz',
                className: 'w-full p-2 rounded-lg bg-[var(--button-bg)] text-[var(--button-text)]',
                onClick: () => {
                  console.log('Clicked Reset button in flag quiz');
                  setFlagCorrectAnswers(0);
                  setFlagIncorrectAnswers(0);
                  localStorage.setItem('flagCorrectAnswers', 0);
                  localStorage.setItem('flagIncorrectAnswers', 0);
                  startFlagQuiz();
                }
              },
              lang === 'ru' ? 'Сбросить' : 'Reset'
            )
          )
        )
      );
    }

    function App() {
      const tg = window.Telegram?.WebApp;
      const [lang, setLang] = React.useState(localStorage.getItem('language') || 'ru');
      const [activeTab, setActiveTab] = React.useState(localStorage.getItem('activeTab') || 'search');
      const [countryInput, setCountryInput] = React.useState('');
      const [suggestions, setSuggestions] = React.useState([]);
      const [result, setResult] = React.useState(null);
      const [countryInfo, setCountryInfo] = React.useState(null);
      const [correctAnswers, setCorrectAnswers] = React.useState(parseInt(localStorage.getItem('correctAnswers')) || 0);
      const [incorrectAnswers, setIncorrectAnswers] = React.useState(parseInt(localStorage.getItem('incorrectAnswers')) || 0);
      const [flagCorrectAnswers, setFlagCorrectAnswers] = React.useState(parseInt(localStorage.getItem('flagCorrectAnswers')) || 0);
      const [flagIncorrectAnswers, setFlagIncorrectAnswers] = React.useState(parseInt(localStorage.getItem('flagIncorrectAnswers')) || 0);

      const updateTheme = () => {
        try {
          if (!tg || !tg.themeParams) {
            console.warn('Telegram WebApp or themeParams not available, using default colors');
            return;
          }
          const themeParams = tg.themeParams || {};
          console.log('Theme parameters:', themeParams);
          document.documentElement.style.setProperty('--bg-color', themeParams.bg_color || '#ffffff');
          document.documentElement.style.setProperty('--text-color', themeParams.text_color || '#000000');
          document.documentElement.style.setProperty('--input-bg', themeParams.secondary_bg_color || '#ffffff');
          document.documentElement.style.setProperty('--input-border', themeParams.hint_color || '#d1d5db');
          document.documentElement.style.setProperty('--button-bg', themeParams.button_color || '#3390ec');
          document.documentElement.style.setProperty('--button-text', themeParams.button_text_color || '#ffffff');
          document.documentElement.style.setProperty('--button-hover', themeParams.button_color ? (themeParams.button_color + 'cc') : '#2563eb');
          document.documentElement.style.setProperty('--suggestions-bg', themeParams.secondary_bg_color || '#ffffff');
          document.documentElement.style.setProperty('--suggestions-border', themeParams.hint_color || '#d1d5db');
          document.documentElement.style.setProperty('--suggestions-hover', themeParams.hint_color ? (themeParams.hint_color + '33') : '#f3f4f6');
          document.documentElement.style.setProperty('--theme-button-bg', themeParams.secondary_bg_color || '#e5e7eb');
          document.documentElement.style.setProperty('--theme-button-text', themeParams.text_color || '#374151');
          document.documentElement.style.setProperty('--error-text', themeParams.destructive_text_color || '#ef4444');
          document.documentElement.style.setProperty('--success-text', themeParams.accent_text_color || '#10b981');
          document.documentElement.style.setProperty('--quiz-button-bg', themeParams.button_color || '#3390ec');
          document.documentElement.style.setProperty('--quiz-button-hover', themeParams.button_color ? (themeParams.button_color + 'cc') : '#2563eb');
          document.documentElement.style.setProperty('--quiz-button-active', themeParams.button_color ? (themeParams.button_color + '99') : '#1e40af');
          document.documentElement.style.setProperty('--quiz-correct-bg', themeParams.accent_text_color || '#10b981');
          document.documentElement.style.setProperty('--quiz-incorrect-bg', themeParams.destructive_text_color || '#ef4444');
        } catch (error) {
          console.error('Error in updateTheme:', error);
        }
      };

      React.useEffect(() => {
        try {
          console.log('Initializing app, Telegram WebApp version:', tg?.version);
          updateTheme();
          if (tg) {
            tg.onEvent('themeChanged', () => {
              console.log('themeChanged event');
              updateTheme();
            });
            return () => {
              tg.offEvent('themeChanged', updateTheme);
            };
          }
        } catch (error) {
          console.error('Error in useEffect:', error);
        }
      }, []);

      const toggleLanguage = () => {
        try {
          const newLang = lang === 'en' ? 'ru' : 'en';
          setLang(newLang);
          localStorage.setItem('language', newLang);
          setCorrectAnswers(0);
          setIncorrectAnswers(0);
          setFlagCorrectAnswers(0);
          setFlagIncorrectAnswers(0);
          localStorage.setItem('correctAnswers', 0);
          localStorage.setItem('incorrectAnswers', 0);
          localStorage.setItem('flagCorrectAnswers', 0);
          localStorage.setItem('flagIncorrectAnswers', 0);
          setCountryInput('');
          setResult(null);
          setCountryInfo(null);
          setSuggestions([]);
          if (tg && typeof tg.showAlert === 'function') {
            console.log('Calling showAlert for language change:', newLang);
            tg.showAlert(`Language: ${newLang === 'ru' ? 'Русский' : 'English'}`);
          } else {
            console.warn('showAlert not available, using standard alert');
            alert(`Language: ${newLang === 'ru' ? 'Русский' : 'English'}`);
          }
        } catch (error) {
          console.error('Error in toggleLanguage:', error);
          if (tg && typeof tg.showAlert === 'function') {
            tg.showAlert('Error changing language');
          } else {
            alert('Error changing language');
          }
        }
      };

      return (
        React.createElement(
          ErrorBoundary,
          null,
          React.createElement(
            'div',
            { className: 'w-full max-w-sm p-4' },
            React.createElement(
              'div',
              { className: 'flex justify-between items-center mb-2' },
              React.createElement('h1', { className: 'text-2xl font-semibold animate-pulse' }, lang === 'ru' ? 'Столицы стран' : 'Country Capitals'),
              React.createElement(
                'button',
                { id: 'langToggle', className: 'p-2 rounded-full bg-[var(--theme-button-bg)] text-[var(--theme-button-text)]', onClick: toggleLanguage },
                lang === 'ru' ? '🇷🇺' : '🇬🇧'
              )
            ),
            React.createElement(
              'nav',
              { className: 'flex gap-2 mb-2' },
              React.createElement('button', { className: `tab ${activeTab === 'search' ? 'active' : ''}`, onClick: () => { setActiveTab('search'); localStorage.setItem('activeTab', 'search'); } }, lang === 'ru' ? 'Поиск' : 'Search'),
              React.createElement('button', { className: `tab ${activeTab === 'quiz' ? 'active' : ''}`, onClick: () => { setActiveTab('quiz'); localStorage.setItem('activeTab', 'quiz'); } }, lang === 'ru' ? 'Викторина' : 'Quiz'),
              React.createElement('button', { className: `tab ${activeTab === 'flagQuiz' ? 'active' : ''}`, onClick: () => { setActiveTab('flagQuiz'); localStorage.setItem('activeTab', 'flagQuiz'); } }, lang === 'ru' ? 'Флаги' : 'Flags')
            ),
            activeTab === 'search' && React.createElement(SearchTab, { lang, result, setResult, countryInfo, setCountryInfo, countryInput, setCountryInput, suggestions, setSuggestions }),
            activeTab === 'quiz' && React.createElement(QuizTab, { lang, correctAnswers, incorrectAnswers, setCorrectAnswers, setIncorrectAnswers }),
            activeTab === 'flagQuiz' && React.createElement(FlagQuizTab, { lang, flagCorrectAnswers, flagIncorrectAnswers, setFlagCorrectAnswers, setFlagIncorrectAnswers })
          )
        )
      );
    }

    try {
      console.log('Rendering app');
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    } catch (error) {
      console.error('Rendering error:', error);
      alert('App rendering error. Check console.');
    }
  </script>
</body>
</html>
